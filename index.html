<script>
  const map = L.map('map').setView([40.85, -73.4], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let geojsonLayer;
  const labelLayer = L.layerGroup().addTo(map);

  function getColor(value) {
    return chroma.scale(['#001f3f', 'white', '#8B0000']).domain([-1, 0, 1])(value).hex();
  }

  const nl2br = s => String(s ?? '').replace(/\r?\n/g, '<br>');
  function fmtPctSmart(v) {
    if (v == null) return '—';
    const s = String(v).trim();
    if (s === '') return '—';
    if (s.endsWith('%')) return s;
    const n = Number(s.replace(/[, ]/g, ''));
    if (!Number.isFinite(n)) return s;
    return `${n.toFixed(1)}%`;
  }

  const fieldsToExclude = new Set([
    'OBJECTID', 'COUNTY', 'LASTUPDATE', 'POLLINGID', 'Shape_Length', 'Shape_Area',
    'Committee Members', 'Highlight', 'HIGHLIGHT'
  ]);

  function drawPopup(props) {
    const name = props.NAME ?? `ED ${props["ED Number"] ?? props.ED ?? ''}`;
    let html = `<div style="min-width:260px">`;
    html += `<div><strong>Election District:</strong> ${name}</div>`;
    if (props.Zone && String(props.Zone).trim() !== '') {
      html += `<div><strong>Zone:</strong> ${props.Zone}</div>`;
    }
    const members = props['Committee Members'];
    if (members && String(members).trim() !== '') {
      html += `<hr><div><strong>Committee Members</strong><br>${nl2br(members)}</div>`;
    }
    html += `<hr><table class="tbl">`;
    const entries = Object.entries(props).sort(([a],[b]) => a.localeCompare(b));
    for (const [key, value] of entries) {
      if (fieldsToExclude.has(key)) continue;
      if (['NAME','ED Number','ED','Zone'].includes(key)) continue;
      let val = value ?? 'N/A';
      if (key.toLowerCase().includes('percent')) val = fmtPctSmart(value);
      html += `<tr><td><b>${key}</b></td><td style="text-align:right">${val}</td></tr>`;
    }
    html += `</table></div>`;
    return html;
  }

  function isMonitored(props) {
    const raw = props.HIGHLIGHT ?? props.Highlight ?? props.highlight;
    return String(raw ?? '').trim().toUpperCase() === 'X';
  }

  function loadGeoJSON(data, csvData = null) {
    if (geojsonLayer) map.removeLayer(geojsonLayer);
    labelLayer.clearLayers();

    const csvMap = new Map();
    if (csvData) {
      csvData.forEach(row => {
        const cleaned = {};
        for (const [key, value] of Object.entries(row)) {
          cleaned[key.trim()] = value;
        }
        const k = cleaned["PRECINCTID"] ?? cleaned["PRECINCT_ID"];
        if (k != null) csvMap.set(String(k).trim(), cleaned);
      });
    }

    data.features.forEach(f => {
      const props = f.properties || {};
      const precinctKey =
        (props.PRECINCTID != null ? String(props.PRECINCTID).trim() : null) ||
        (props.PRECINCT_ID != null ? String(props.PRECINCT_ID).trim() : null);
      const row = precinctKey ? csvMap.get(precinctKey) : null;
      if (row) f.properties = { ...props, ...row };
    });

    geojsonLayer = L.geoJSON(data, {
      style: function (feature) {
        // Look for "Percent Difference"
        let marginRaw = null;
        for (const k of Object.keys(feature.properties)) {
          if (k.trim().toLowerCase().includes("percent difference")) {
            marginRaw = feature.properties[k];
            break;
          }
        }

        let margin = 0;
        if (typeof marginRaw === 'string' && marginRaw.includes('%')) {
          margin = Number(marginRaw.replace('%', '').trim());
        } else {
          margin = Number(marginRaw);
        }

        const norm = isNaN(margin) ? 0 : margin / 100;
        console.log("Margin Raw:", marginRaw, "→ Normalized:", norm); // Debug
        return {
          fillColor: getColor(norm),
          color: "#333",
          weight: 1,
          fillOpacity: 0.85
        };
      },
      onEachFeature: function (feature, layer) {
        const p = feature.properties;
        layer.bindPopup(drawPopup(p));

        try {
          const center = turf.centroid(feature).geometry.coordinates;
          const edText = p["ED Number"] ?? p.ED_Number ?? "";

          const labelClass = isMonitored(p) ? 'ed-label ed-label--highlight' : 'ed-label';
          const iconSize = isMonitored(p) ? [28, 28] : [40, 20];
          const iconAnchor = isMonitored(p) ? [14, 14] : [20, 10];

          const label = L.marker([center[1], center[0]], {
            icon: L.divIcon({
              className: labelClass,
              html: `<div>${edText}</div>`,
              iconSize: iconSize,
              iconAnchor: iconAnchor
            }),
            interactive: false
          });
          labelLayer.addLayer(label);
        } catch (e) { /* ignore bad geometry */ }
      }
    }).addTo(map);
  }

  // Initial load
  fetch("Election_District.geojson")
    .then(res => res.json())
    .then(data => loadGeoJSON(data));

  // CSV upload
  document.getElementById("csvFile").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
      header: true,
      dynamicTyping: false,
      skipEmptyLines: 'greedy',
      complete: function(results) {
        fetch("Election_District.geojson")
          .then(res => res.json())
          .then(data => loadGeoJSON(data, results.data));
      }
    });
  });
</script>
